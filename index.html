<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ensaio Dielétrico</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root{
    --primary:#0097CE;
    --primary-dark:#007aa5;
    --bg:#f4f6f8;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow: 0 18px 60px rgba(17,24,39,.12);
    --shadow-soft: 0 10px 25px rgba(17,24,39,.08);
    --radius: 18px;
    --radius-sm: 14px;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    min-height:100vh;
    font-family: "Segoe UI", Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 10% 0%, rgba(0,151,206,.22), transparent 55%),
      radial-gradient(1000px 520px at 90% 15%, rgba(0,151,206,.12), transparent 60%),
      var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 18px;
    color: var(--text);
  }

  .shell{ width: min(1200px, 100%); }

  .brand{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom: 14px;
    color: var(--primary);
    font-weight: 900;
    letter-spacing: .2px;
  }
  .brand i{
    width:44px;height:44px;border-radius: 14px;
    display:flex;align-items:center;justify-content:center;
    background: rgba(0,151,206,.12);
    border: 1px solid rgba(0,151,206,.22);
    font-size: 20px;
  }

  .card{
    background: var(--card);
    border: 1px solid rgba(229,231,235,.9);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  /* LOGIN */
  #loginView{ width: min(470px, 100%); margin: 0 auto; }
  .card-header{ padding: 20px 20px 0 20px; }

  h2{ margin:0; font-size: 20px; }
  .sub{
    margin: 8px 0 0 0;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.45;
  }

  form.login-form{
    padding: 16px 20px 20px 20px;
    display:grid;
    gap: 12px;
  }

  label{
    font-size: 12px;
    font-weight: 900;
    color: #374151;
    display:flex;
    align-items:center;
    gap: 8px;
    margin-bottom: 6px;
    letter-spacing: .2px;
    text-transform: none;
  }

  .field{ display:grid; gap:6px; }
  .input-wrap{ position: relative; }

  input, select{
    width:100%;
    padding: 14px 14px 14px 44px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: #fff;
    font-size: 16px;
    outline: none;
    transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
  }
  select{ padding-left: 14px; }

  input:focus, select:focus{
    border-color: rgba(0,151,206,.6);
    box-shadow: 0 0 0 4px rgba(0,151,206,.18);
  }

  .input-icon{
    position:absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 18px;
    pointer-events: none;
  }

  .row-actions{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    margin-top: 2px;
  }
  .hint{ font-size: 12px; color: var(--muted); }

  button{
    width:100%;
    padding: 14px 16px;
    background: var(--primary);
    border: none;
    color: #fff;
    font-size: 16px;
    font-weight: 950;
    border-radius: 14px;
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 10px;
    transition: transform .08s ease, filter .15s ease, background .15s ease;
    user-select:none;
  }
  button:hover{ background: var(--primary-dark); }
  button:active{ transform: translateY(1px); }
  button:disabled{ opacity: .75; cursor:not-allowed; }

  .spinner{
    width: 16px; height: 16px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,.45);
    border-top-color: #fff;
    animation: spin .9s linear infinite;
    display:none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .erro{
    display:none;
    margin: 0 20px 20px 20px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(179,38,30,.22);
    background: rgba(179,38,30,.08);
    color: #b3261e;
    font-size: 13px;
    line-height: 1.35;
  }

  /* FORM */
  #formView{ display:none; }

  .topbar{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 18px;
    border-bottom: 1px solid rgba(229,231,235,.9);
    background: linear-gradient(90deg, rgba(0,151,206,.10), rgba(0,151,206,.04));
  }
  .topbar .title{
    display:flex; align-items:center; gap:10px;
    font-weight: 950;
  }
  .badge{
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    background: rgba(0,151,206,.12);
    border: 1px solid rgba(0,151,206,.22);
    color: var(--primary-dark);
    font-weight: 900;
  }
  .btn-logout{
    width: auto;
    padding: 10px 12px;
    border-radius: 14px;
    background: #ef4444;
    font-weight: 900;
  }
  .btn-logout:hover{ background:#dc2626; }

  .content{ padding: 22px; }

  .form-title{
    margin: 0 0 6px 0;
    font-size: 22px;
    font-weight: 1000;
  }
  .form-sub{
    margin: 0 0 16px 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.4;
  }

  /* ✅ Seção (para agrupar campos) */
  .section{
    background: #fff;
    border: 1px solid rgba(229,231,235,.9);
    border-radius: 18px;
    box-shadow: var(--shadow-soft);
    padding: 16px;
    margin-bottom: 14px;
  }
  .section-title{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight: 950;
    margin: 0 0 12px 0;
    color: #111827;
  }
  .section-title i{
    color: var(--primary-dark);
    background: rgba(0,151,206,.10);
    border: 1px solid rgba(0,151,206,.18);
    border-radius: 12px;
    width: 36px;
    height: 36px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* ✅ grid melhor */
  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 14px;
  }
  .grid .full{ grid-column: 1 / -1; }

  .field2 label{ margin-bottom: 6px; }
  .field2 input, .field2 select{
    padding: 14px 14px;
    font-size: 16px;
  }

  /* ✅ barra de ação mais bonita */
  .actions{
    display:flex;
    gap: 12px;
    margin-top: 12px;
  }
  .actions .primary{
    flex: 1;
  }

  @media (max-width: 980px){
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 600px){
    body{ padding: 12px; }
    .content{ padding: 14px; }
    .grid{ grid-template-columns: 1fr; }
    .section{ padding: 14px; }
  }

  @media (prefers-reduced-motion: reduce){
    * { transition: none !important; animation: none !important; }
  }

  /* ✅ botão enviar fixo no mobile (opcional e bonito) */
  .sticky-submit{
    display:none;
  }
  @media (max-width: 600px){
    .sticky-submit{
      display:block;
      position: sticky;
      bottom: 10px;
      margin-top: 14px;
      background: rgba(244,246,248,.75);
      backdrop-filter: blur(8px);
      padding: 10px;
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.9);
    }
  }
</style>
</head>

<body>
  <div class="shell">
    <div class="brand">
      <i class="bi bi-shield-lock"></i>
      <span>Ensaio Dielétrico</span>
    </div>

    <!-- LOGIN VIEW -->
    <div id="loginView">
      <div class="card">
        <div class="card-header">
          <h2>Entrar</h2>
          <p class="sub">Use sua matrícula e senha cadastradas para acessar o formulário.</p>
        </div>

        <form class="login-form" onsubmit="event.preventDefault(); fazerLogin();">
          <div class="field">
            <label for="matricula"><i class="bi bi-person"></i> Matrícula</label>
            <div class="input-wrap">
              <i class="bi bi-person input-icon"></i>
              <input type="text" id="matricula" placeholder="Digite sua matrícula" autocomplete="username" />
            </div>
          </div>

          <div class="field">
            <label for="senha"><i class="bi bi-lock"></i> Senha</label>
            <div class="input-wrap">
              <i class="bi bi-lock input-icon"></i>
              <input type="password" id="senha" placeholder="Digite sua senha" autocomplete="current-password" />
            </div>
          </div>

          <div class="row-actions">
            <div class="hint">Dica: matrícula + senha do cadastro.</div>
          </div>

          <button id="btnLogin" type="submit">
            <span class="spinner" id="spinner"></span>
            <i class="bi bi-box-arrow-in-right"></i>
            <span id="btnText">Entrar</span>
          </button>
        </form>

        <div class="erro" id="erro"></div>
      </div>
    </div>

    <!-- FORM VIEW -->
    <div id="formView">
      <div class="card">
        <div class="topbar">
          <div class="title">
            <i class="bi bi-clipboard2-check"></i>
            <span>Registro de Ensaio</span>
            <span class="badge" id="badgeUser">logado</span>
          </div>
          <a id="btnListar" 
   href="https://coec-epb.github.io/listar_ensaios/" 
   target="_blank"
   style="display:none; text-decoration:none;">
   <button style="background:#0ea5e9;">
     <i class="bi bi-list-ul"></i>
     Listar Ensaios
   </button>
</a>
          <button class="btn-logout" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Sair
          </button>
        </div>

        <div class="content">
          <div class="form-title">Formulário – Ensaio Dielétrico</div>
          <div class="form-sub">Preencha os dados abaixo e clique em enviar.</div>

          <form id="formEnsaio">

  <!-- Seção 1 -->
  <div class="section">
    <div class="section-title">
      <i class="bi bi-person-badge"></i>
      <span>Dados:</span>
    </div>

    <div class="grid">
      <div class="field2">
        <label>Nome</label>
        <select name="nome" id="nome" required>
          <option value="">Selecione</option>
          <option value="Ednaldo Jose dos Santos">Ednaldo Jose dos Santos</option>
          <option value="Wesley Fernandes de Souza">Wesley Fernandes de Souza</option>
          <option value="Wandemberg Angelo da Costa">Wandemberg Angelo da Costa</option>
        </select>
      </div>

      <div class="field2">
        <label>Email</label>
        <select name="email" id="email" required>
          <option value="">Selecione</option>
          <option value="ejs5@energisa.com.br">ejs5@energisa.com.br</option>
          <option value="wesley.souza@energisa.com.br">wesley.souza@energisa.com.br</option>
          <option value="wandemberg.costa@energisa.com.br">wandemberg.costa@energisa.com.br</option>
        </select>
      </div>

      <div class="field2">
        <label>Departamento</label>
        <select name="departamento" required>
          <option value="">Selecione</option>
          <option>DEOP</option>
          <option>DCMD</option>
          <option>AUTOMAÇÃO</option>
          <option>DCMD_LV</option>
          <option>DEAT</option>
          <option>DECP</option>
          <option>DESC</option>
          <option>DESU</option>
          <option>SESMT</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Seção 2 -->
  <div class="section">
    <div class="section-title">
      <i class="bi bi-geo-alt"></i>
      <span>Local e identificação</span>
    </div>

    <div class="grid">
      <div class="field2">
        <label>Data</label>
        <input type="date" name="data" id="data" required>
      </div>

      <div class="field2">
        <label>Regional</label>
        <select name="regional" required>
          <option value="">Selecione</option>
          <option>Leste</option>
          <option>Centro</option>
          <option>Oeste</option>
        </select>
      </div>

      <div class="field2">
        <label>Localidade</label>
        <input type="text" name="localidade" required>
      </div>    
    </div>
  </div>

  <!-- Seção 3 -->
  <div class="section">
    <div class="section-title">
      <i class="bi bi-lightning-charge"></i>
      <span>Dados do ensaio</span>
    </div>

    <div class="grid">
       <div class="field2 full">
        <label>Código Inicial</label>
        <input type="text" name="cod_inicial" required>
      </div>

      <div class="field2 full">
        <label>Código Final</label>
        <input type="text" name="cod_final" required>
      </div>

      <div class="field2 full">
        <label>Elementos</label>
        <input type="text" name="elementos" required>
      </div>


      
      <div class="field2 full">
        <label>Equipamentos Isolantes</label>
        <select name="equipamentos" required>
          <option value="">Selecione</option>
          <option>Aterramento MT</option>
          <option>Andaime Isolante</option>
          <option>Banqueta Isolada</option>
          <option>Bastão Aspiral</option>
          <option>Bastão de Berço</option>
          <option>Bastão de Tração</option>
          <option>Bastão Garra</option>
          <option>Bastão Liso</option>
          <option>Bastão Pega tudo</option>
          <option>Bastão Separador de Corda</option>
          <option>Bastão Suporte By Pass</option>
          <option>Bastão Tensor</option>
          <option>Bastão Universal</option>
          <option>Bastão Vara de Manobra</option>
          <option>Bastão Vara Telescópica</option>
          <option>By Pass</option>
          <option>Cobertura Circular</option>
          <option>Cobertura de Cond. Flexivel</option>
          <option>Cobertura de Cond. Rigida</option>
          <option>Escada 13.8 kV</option>
          <option>Escada 69 kV</option>
          <option>Escada Pedarol</option>
          <option>Fasimetro</option>
          <option>Lençou Isolante LV</option>
          <option>Luva Isolante BT</option>
          <option>Luva Isolante MT</option>
          <option>Luva Isolante SED</option>
          <option>Manga Isolante BT</option>
          <option>Manga Isolante MT</option>
          <option>Manta Isolante BT</option>
          <option>Separador de Escada</option>
          <option>SKY Lança Classe B - 69 KW</option>
          <option>SKY Lança Classe C - 46 KW</option>
          <option>SKY Liner</option>
          <option>Talha</option>
          <option>Tesourão a Distância</option>
          <option>Tesourão Pequeno</option>
          <option>Travessa de Andaime</option>
        </select>
      </div>

      <div class="field2 full">
        <label>Tipo de Ensaio</label>
        <select name="tipo_ensaio" required>
          <option value="">Selecione</option>
          <option>Tensão Aplicada 30KV C.A por 1 min</option>
          <option>Tensão Aplicada 5KV C.A por 1 min</option>
          <option>Tensão Aplicada 20KV C.A por 1 min</option>
          <option>Tensão Aplicada 100KV C.A por 1 min a cada 30cm</option>
          <option>Tensão Aplicada 40KV C.A por 1 min</option>
          <option>Tensão Aplicada 15KV C.A por 1 min</option>
          <option>Tensão Aplicada 100KV C.A por 1 min</option>
          <option>Tensão Aplicada 50KV C.A por 1 min</option>
          <option>Tensão Aplicada 24KV C.A por 1 min</option>
          <option>Tensão Aplicada 14KV C.A por 1 min</option>
        </select>
      </div>

      <div class="field2 full">
        <label>Norma Utilizada</label>
        <select name="norma" required>
          <option value="">Selecione</option>
          <option>NBR 10622 - Luvas isolantes de borracha</option>
          <option>NBR 10623 - Mangas isolantes de borracha</option>
          <option>NBR 11854 - Bastão isolante para trabalho em redes energizadas de distribuição</option>
          <option>NBR 11855 - Plataforma isolante para trabalho em redes energizadas de distribuição</option>
          <option>NBR 11856 - Ferramentas e acessórios para trabalhos em redes energizadas de distribuição</option>
          <option>NBR 14540 - Bastão e escada isolantes e ferragens para trabalho em instalação energizada – Transmissão</option>
          <option>NBR 16092 - Cestas aéreas</option>
          <option>NBR 5720 - Coberturas sólidas</option>
          <option>NBR 8221 - Capacete de segurança para uso ocupacional</option>
        </select>
      </div>

      <div class="field2">
        <label>Corrente de Fuga (µA)</label>
        <input type="number" step="0.01" name="corrente_fuga" required>
      </div>

      <div class="field2">
        <label>Resultado</label>
        <select name="resultado" required>
          <option value="">Selecione</option>
          <option>Aprovado</option>
          <option>Reprovado</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="primary" type="submit">
        <i class="bi bi-send"></i>
        Enviar Registro
      </button>
    </div>

    
    </div>
  </div>

</form>
        </div>
      </div>
    </div>

  </div>

<script>
  const WORKER_URL = "https://ensai-dieletrico.pedro-fillype.workers.dev";

  function showLogin() {
    document.getElementById("loginView").style.display = "block";
    document.getElementById("formView").style.display = "none";
  }
  function showForm() {
    const PERMITIDOS = ["9170", "3080117", "3005906", "8667"];
const matricula = localStorage.getItem("matricula");

if (!PERMITIDOS.includes(matricula)) {
  document.querySelector("#formEnsaio button[type='submit']").disabled = true;
}
    document.getElementById("loginView").style.display = "none";
    document.getElementById("formView").style.display = "block";
    document.getElementById("data").value = new Date().toISOString().split("T")[0];
  }

  window.onload = () => {
  const token = localStorage.getItem("token");
  const matricula = localStorage.getItem("matricula") || "logado";

  const PERMITIDOS = ["9170", "3080117", "3005906", "8667"];

  if (token) {
    document.getElementById("badgeUser").innerText = matricula;
    showForm();

    if (PERMITIDOS.includes(matricula)) {
      document.getElementById("btnListar").style.display = "inline-block";
    }
  } else {
    showLogin();
  }
};

  function setLoading(isLoading) {
    const btn = document.getElementById("btnLogin");
    const sp = document.getElementById("spinner");
    const txt = document.getElementById("btnText");
    btn.disabled = isLoading;
    sp.style.display = isLoading ? "inline-block" : "none";
    txt.innerText = isLoading ? "Entrando..." : "Entrar";
  }

  function showError(msg) {
    const el = document.getElementById("erro");
    el.style.display = "block";
    el.innerText = msg;
  }

  function clearError() {
    const el = document.getElementById("erro");
    el.style.display = "none";
    el.innerText = "";
  }

  async function fazerLogin() {
    clearError();
    const matricula = document.getElementById("matricula").value.trim();
    const senha = document.getElementById("senha").value.trim();

    if (!matricula || !senha) {
      showError("Informe matrícula e senha.");
      return;
    }

    setLoading(true);

    try {
      const r = await fetch(WORKER_URL + "/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ matricula, senha })
      });

      const j = await r.json().catch(() => ({}));

      if (!r.ok) {
        showError(j.error || "Usuário ou senha inválidos.");
        return;
      }

      localStorage.setItem("token", j.token);
      localStorage.setItem("matricula", j.matricula || matricula);

      document.getElementById("badgeUser").innerText = j.matricula || matricula;
      showForm();
    } catch (e) {
      showError("Falha ao conectar no servidor. Tente novamente.");
    } finally {
      setLoading(false);
    }
  }

  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("matricula");
    location.reload();
  }

  // ====== Nome <-> Email automático ======
  const nomeEl = document.getElementById("nome");
  const emailEl = document.getElementById("email");

  const nomeParaEmail = {
    "Ednaldo Jose dos Santos": "ejs5@energisa.com.br",
    "Wesley Fernandes de Souza": "wesley.souza@energisa.com.br",
    "Wandemberg Angelo da Costa": "wandemberg.costa@energisa.com.br"
  };
  const emailParaNome = Object.fromEntries(
    Object.entries(nomeParaEmail).map(([n,e]) => [e.toLowerCase(), n])
  );

  nomeEl.addEventListener("change", () => {
    emailEl.value = nomeParaEmail[nomeEl.value] || "";
  });

  emailEl.addEventListener("change", () => {
    const email = (emailEl.value || "").toLowerCase();
    nomeEl.value = emailParaNome[email] || "";
  });

  // ====== Envio do formulário com token ======
  document.getElementById("formEnsaio").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Sessão expirada. Faça login novamente.");
      logout();
      return;
    }

    const dados = Object.fromEntries(new FormData(e.target).entries());

    try {
      const response = await fetch(WORKER_URL + "/salvar-ensaio", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(dados)
      });

      const res = await response.json().catch(() => ({}));

      if (!response.ok) {
        alert((res.error || "Erro ao salvar") + (res.detail ? "\n\n" + res.detail : ""));
        return;
      }

      alert(res.message || "Registro salvo!");
      e.target.reset();
      document.getElementById("data").value = new Date().toISOString().split("T")[0];
    } catch (err) {
      alert("Falha ao conectar no servidor.");
    }
  });
</script>

</body>
</html>
