<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ensaio Dielétrico</title>

<style>
:root {
  --azul: #0097CE;
  --azul-escuro: #0079A6;
  --laranja: #F36F21;
  --fundo: #eef3f6;
}

body {
  margin: 0;
  padding: 0;
  background: var(--fundo);
  font-family: Arial, sans-serif;
}

.container {
  max-width: 850px;
  background: white;
  margin: 40px auto;
  padding: 35px;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  border-top: 8px solid var(--azul);
}

h2 {
  text-align: center;
  color: var(--azul-escuro);
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  margin-bottom: 15px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  background: var(--azul);
  color: white;
  font-size: 16px;
  cursor: pointer;
}

button:hover {
  background: var(--azul-escuro);
}

#formContainer {
  display: none;
}

.logout-btn {
  background: #dc3545;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginContainer">
  <h2>Login</h2>

  <label>Matrícula</label>
  <input type="text" id="matricula">

  <label>Senha</label>
  <input type="password" id="senha">

  <button onclick="fazerLogin()">Entrar</button>
</div>

<!-- FORMULÁRIO -->
<div class="container" id="formContainer">
  <button class="logout-btn" onclick="logout()">Sair</button>

  <h2>Formulário – Ensaio Dielétrico</h2>

  <form id="formEnsaio">

    <label>Data:</label>
    <input type="date" name="data" id="data" required>

    <label>Nome:</label>
    <select name="nome" id="nome" required>
      <option value="">Selecione</option>
      <option value="Ednaldo Jose dos Santos">Ednaldo Jose dos Santos</option>
      <option value="Wesley Fernandes de Souza">Wesley Fernandes de Souza</option>
      <option value="Wandemberg Angelo da Costa">Wandemberg Angelo da Costa</option>
    </select>

    <label>Email:</label>
    <select name="email" id="email" required>
      <option value="">Selecione</option>
      <option value="ejs5@energisa.com.br">ejs5@energisa.com.br</option>
      <option value="wesley.souza@energisa.com.br">wesley.souza@energisa.com.br</option>
      <option value="wandemberg.costa@energisa.com.br">wandemberg.costa@energisa.com.br</option>
    </select>

    <label>Departamento:</label>
    <select name="departamento" required>
      <option value="">Selecione</option>
      <option>DEOP</option>
      <option>DCMD</option>
      <option>AUTOMAÇÃO</option>
      <option>DCMD_LV</option>
      <option>DEAT</option>
      <option>DECP</option>
      <option>DESC</option>
      <option>DESU</option>
      <option>SESMT</option>
    </select>

    <label>Regional:</label>
    <select name="regional" required>
      <option value="">Selecione</option>
      <option>Leste</option>
      <option>Centro</option>
      <option>Oeste</option>
    </select>

    <label>Localidade:</label>
    <input type="text" name="localidade" required>

    <label>Código Inicial:</label>
    <input type="text" name="cod_inicial" required>

    <label>Código Final:</label>
    <input type="text" name="cod_final" required>

    <label>Elementos:</label>
    <input type="text" name="elementos" required>

    <label>Corrente de Fuga (µA):</label>
    <input type="number" step="0.01" name="corrente_fuga" required>

    <label>Resultado:</label>
    <select name="resultado" required>
      <option value="">Selecione</option>
      <option>Aprovado</option>
      <option>Reprovado</option>
    </select>

    <button type="submit">Enviar Registro</button>

  </form>
</div>

<script>
const WORKER_URL = "https://ensai-dieletrico.pedro-fillype.workers.dev";

// Verifica se já está logado
window.onload = () => {
  const token = localStorage.getItem("token");
  if (token) {
    mostrarFormulario();
  }
};

function mostrarFormulario() {
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("formContainer").style.display = "block";
  document.getElementById("data").value = new Date().toISOString().split("T")[0];
}

function logout() {
  localStorage.removeItem("token");
  location.reload();
}

async function fazerLogin() {
  const matricula = document.getElementById("matricula").value.trim();
  const senha = document.getElementById("senha").value.trim();

  try {
    const r = await fetch(WORKER_URL + "/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ matricula, senha })
    });

    const j = await r.json().catch(() => ({}));
    if (!r.ok) {
      alert(j.error || "Falha no login");
      return;
    }

    localStorage.setItem("token", j.token);
    mostrarFormulario();
  } catch (e) {
    alert("Falha ao conectar no Worker (verifique se publicou e se o /login está ok).");
  }
}

// Auto preencher nome/email
const nomeParaEmail = {
  "Ednaldo Jose dos Santos": "ejs5@energisa.com.br",
  "Wesley Fernandes de Souza": "wesley.souza@energisa.com.br",
  "Wandemberg Angelo da Costa": "wandemberg.costa@energisa.com.br"
};

const emailParaNome = Object.fromEntries(
  Object.entries(nomeParaEmail).map(([n,e]) => [e,n])
);

document.getElementById("nome").addEventListener("change", e => {
  document.getElementById("email").value = nomeParaEmail[e.target.value] || "";
});

document.getElementById("email").addEventListener("change", e => {
  document.getElementById("nome").value = emailParaNome[e.target.value] || "";
});

// Envio protegido com token
document.getElementById("formEnsaio").addEventListener("submit", async function(e){
  e.preventDefault();

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Sessão expirada.");
    return;
  }

  const form = e.target;

  const dados = Object.fromEntries(new FormData(form).entries());

  const response = await fetch(WORKER_URL + "/salvar-ensaio", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(dados)
  });

  const res = await response.json();
  alert(res.message || res.error);

  if (res.message) form.reset();
});
</script>

</body>
</html>
